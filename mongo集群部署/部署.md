# 1.环境准备

下载docker、docker-compose、mysql

# 2. 生成 keyFile

- MongoDB 使用 keyfile 认证，副本集中的每个 mongod 实例使用 keyfile 内容作为认证其他成员的共享密码。mongod 实例只有拥有正确的 keyfile 才可以加入副本集

- keyFile 的内容必须是 6 到 1024 个字符的长度，且副本集所有成员的keyFile 内容必须相同

- 有一点要注意是的：在 UNIX 系统中，keyFile 必须没有组权限或完全权限（也就是权限要设置成 X00 的形式）。Windows 系统中，keyFile 权限没有被检查

- 可以使用任意方法生成 keyFile。例如，如下操作使用`openssl`生成复杂的随机的 1024 个字符串。然后使用 chmod 修改文件权限，只给文件拥有者提供读权限。

- mongodb 官方推荐 keyfile 生成方式

  ```bash
  # 400权限是要保证安全性，否则mongod启动会报错
  openssl rand -base64 756 > mongodb.key
  chmod 400 mongodb.key
  ```

![](部署.assets/image-20200902112930217.png)



# 3.配置文件

==这里的配置文件中的version需要注意与 docker-compose版本对应，写错将无法执行==

对应表如下

![image-20200904151502939](部署.assets/image-20200904151502939.png)

docker-compose.yml

```bash
version: '3.1'

services:
  mongodb1:
    image: mongo:4.0
    restart: always
    container_name: mongo1
    volumes:
      - ./data/db/mongo1:/data/db
      - ./mongodb.key:/data/mongodb.key
    ports:
      - 27017:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    networks:
      - mongoNet
    command: mongod --replSet mongos --keyFile /data/mongodb.key
    entrypoint:
      - bash
      - -c
      - |
        chmod 400 /data/mongodb.key
        chown 999:999 /data/mongodb.key
        exec docker-entrypoint.sh $$@

  mongodb2:
    image: mongo:4.0
    restart: always
    container_name: mongo2
    volumes:
      - ./data/db/mongo2:/data/db
      - ./mongodb.key:/data/mongodb.key
    ports:
      - 27018:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    networks:
      - mongoNet
    command: mongod --replSet mongos --keyFile /data/mongodb.key
    entrypoint:
      - bash
      - -c
      - |
        chmod 400 /data/mongodb.key
        chown 999:999 /data/mongodb.key
        exec docker-entrypoint.sh $$@

  mongodb3:
    image: mongo:4.0
    restart: always
    container_name: mongo3
    volumes:
      - ./data/db/mongo3:/data/db
      - ./mongodb.key:/data/mongodb.key
    ports:
      - 27019:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    networks:
      - mongoNet
    command: mongod --replSet mongos --keyFile /data/mongodb.key
    entrypoint:
      - bash
      - -c
      - |
        chmod 400 /data/mongodb.key
        chown 999:999 /data/mongodb.key
        exec docker-entrypoint.sh $$@
    
networks:
  mongoNet:
    driver: bridge
```

![ ](部署.assets/image-20200902113108910.png)

创建环境变量文件.env,  由于是隐藏文件，需要使用ls  -a查看

```yaml
MONGO_INITDB_ROOT_USERNAME=root
MONGO_INITDB_ROOT_PASSWORD=5tgbNHY^
```

![ ](部署.assets/image-20200902113308124.png)

# 4.配置副本集

- 切换到`docker-compose.yml`所在目录，使用`docker-compose up -d`启动 mongodb
- `docker exec -it mongo1 bash`进入容器进行配置
  - 进入容器后，使用`mongo -u root -p 5tgbNHY^`命令进入数据库，显示如下内容（账号/密码在上面的`.env`文件里设置的）

![ ](部署.assets/image-20200902113503686.png)

* 输入`rs.status()`会提示如下表示没有配置副本集

```bash
> rs.status()
{
	"ok" : 0,
	"errmsg" : "no replset config has been received",
	"code" : 94,
	"codeName" : "NotYetInitialized"
}
>
```

- 复制以下内容初始化副本集配置，其中 ip 是宿主机的 IP，注意不要使用容器IP,如果设置了容器 IP，数据库之间能进行通信，但是通过连接无法正确连接副本集，_id 的值是 docker-compose 配置文件启动命令设置的 --replSet mongos ，mongos副本集名称，这是最基础的配置，使用 rs.initiate() 触发选举，并选举出一个成员作为 primary。

```bash
rs.initiate({
    _id: "mongos",
    members: [
        { _id : 0, host : "192.168.75.133:27017" },
        { _id : 1, host : "192.168.75.133:27018" },
        { _id : 2, host : "192.168.75.133:27019" }
    ]
});
```

- 执行初始化配置命令，显示`{"ok" : 1}`代表成功，等待一会儿就会选举出 PRIMARY 节点，可以用`rs.status()`查看当前副本集状态。==执行出错请先关闭防火墙==

  ![ ](部署.assets/image-20200902115653586-1599023953320.png)

  

  状态表如图

| **数字** | **名称**   | **状态描述**                                                 |
| -------- | ---------- | ------------------------------------------------------------ |
| 0        | STARTUP    | 还不是任何集合的活动成员。所有的成员启动在该状态。在STARTUP状态mongod解析副本集配置文档。 |
| 1        | PRIMARY    | 处于PRIMARY状态的成员是唯一能接受写操作的成员。              |
| 2        | SECONDARY  | 处于SECONDARY状态的成员复制数据存储。数据可用于读，尽管可能比较旧。 |
| 3        | RECOVERING | 可以选举。成员要么实施启动自检测，或完成回滚或重新同步的转换。 |
| 5        | STARTUP2   | 成员加入了集合，正运行初始化同步。                           |
| 6        | UNKNOWN    | 成员的状态，正如从集合的另一个成员中所看到的，未知。         |
| 7        | ARBITER    | 仲裁不复制数据，而仅仅参与选举。                             |
| 8        | DOWN       | 该成员，正如从集合的立即你跟一个成员所见，不可达。           |
| 9        | ROLLBACK   | 该成员正在实施回滚。数据不可读。                             |
| 10       | REMOVED    | 成员曾今在副本集但随后被移除。                               |

# 5.创建自定义用户/数据库

```bash
mongos:PRIMARY> use admin
switched to db admin
mongos:PRIMARY> db.auth("root","5tgbNHY^")
1
mongos:PRIMARY> use organization
switched to db organization
mongos:PRIMARY> db.createUser({user: "yuanzx",pwd: "5tgbNHY^",roles: ["readWrite"]})
Successfully added user: { "user" : "yuanzx", "roles" : [ "readWrite" ] }
mongos:PRIMARY>
```

# 6.springboot配置

```yaml
  mongodb://yuanzx:5tgbNHY^@192.168.75.133.137:27018,192.168.75.133:27017,192.168.75.133:27019/organization?replicaSet=mongos&write=1&authMechanism=SCRAM-SHA-1
       
```

# 7.连接测试

连接软件Studio 3T，其他软件也行

![image-20200902132242966](部署.assets/image-20200902132242966.png)

![image-20200902132251629](部署.assets/image-20200902132251629.png)